<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
    <title>Decrease EBS volume (AWS) Â· Hugo Themes</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="http://localhost:1313/style.main.min.b98e12e6b4acb157747422458845caf0880e6eda788e2e2ee3ecc617a0e9bfc3.css" />

</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
        <a class="site-nav-logo" href="http://localhost:1313/">Hugo Themes</a>
        

        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem">
                    <a href="/">HOME</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="/my-setup">MY SETUP</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="/story">THE STORY</a>
                </li>
                
            </ul>

            
            <span class="nav-post-title dash">Decrease EBS volume (AWS)</span>
            
        </div>
    </div>

    <div class="site-nav-right">
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem">
                    <a href="https://www.linkedin.com/in/bradley-stannard/">Linkedin</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="https://documentation.breadnet.co.uk/?mtm_campaign=breadnet&amp;mtm_kwd=navbar">Documentation</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="mailto:webmaster@breadnet.co.uk">Contact</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="https://github.com/userbradley">GitHub</a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>
</div>
</div><script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.Casper && window.Casper.stickyNavTitle) {
                window.Casper.stickyNavTitle({
                    navSelector: '.site-nav-main',
                    titleSelector: '.post-full-title',
                    activeClass: 'nav-post-title-active'
                });
            }
        });
    </script>
</header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post  no-image ">

            <header class="post-full-header">

                

                <h1 class="post-full-title">Decrease EBS volume (AWS)</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        

                        <section class="post-full-byline-meta">
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="0001-121-01">1 January 0001</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 3 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            

            <section class="post-full-content">
                <div class="post-content">
                    <p>It&rsquo;s rare for me to blog about AWS considering I am mainly GCP focused, but this stumped me enough to the point I think it can be of use.</p>
<p>Let&rsquo;s start</p>
<hr>
<p>AWS doesn&rsquo;t allow you to shrink an EBS volume, so our only way to do it is to create a new volume, move everything over then remap it.</p>
<h3 id="getting-started">Getting started</h3>
<p>We will assume:</p>
<ol>
<li>An instance running us us-east-1e</li>
<li>300GB EBS volume named <code>old</code></li>
<li>We want to create a new one of 100gb (we will call it <code>new-vol</code>)</li>
</ol>
<p>We need to shutdown the instance to prevent issues and inconsistencies.</p>
<p>I suggest snapshotting the old volume before doing any work. This is just a <a href="https://en.wikipedia.org/wiki/Cover_your_ass">CYA</a> precaution! (Remember to delete it later to save costs)</p>
<hr>
<ul>
<li>
<p>Install ncdu on the instance (This is just to see the current size of all the files)</p>
</li>
<li>
<p>Change directory to / and run sudo ncdu</p>
</li>
<li>
<p>Create the new volume</p>
</li>
<li>
<p>Choose the region you wish to deploy it to</p>
</li>
<li>
<p>Choose the size and the type</p>
</li>
<li>
<p>Add the relevant tags</p>
</li>
<li>
<p><code>name</code> : <code>new-vol</code></p>
</li>
</ul>
<p><img src="__GHOST_URL__/content/images/2021/06/image.png" alt="">Creating the new VOL</p>
<ul>
<li>Shutdown the instance (<code>sudo shutdown</code> on the instance)</li>
<li>Right click the new Volume</li>
<li>Click <code>Attach Volume</code></li>
<li>Choose the instance either by Name or ID (I prefer ID)</li>
</ul>
<h3 id="now-we-need-to-start-the-instance-and-format-the-volume">Now we need to start the instance and format the Volume</h3>
<ul>
<li>
<p>Check if the volume has got data on it (Can never be too sure)</p>
</li>
<li>
<p><code>sudo file -s /dev/xvdf</code></p>
</li>
<li>
<p>It should return <code>/dev/xvdf: data</code></p>
</li>
<li>
<p>If it does not, stop and re-assess the situation</p>
</li>
<li>
<p>Format the volume</p>
</li>
<li>
<p><code>sudo mkfs -t ext4 /dev/xvdf</code></p>
</li>
</ul>
<h3 id="mount-the-new-volume-to-the-instance">Mount the new volume to the instance</h3>
<ul>
<li>
<p>Create the directory to mount the disk to</p>
</li>
<li>
<p><code>mkdir /mnt/new-vol</code></p>
</li>
<li>
<p><code>sudo mount /dev/xvdf /mnt/new-vol</code></p>
</li>
</ul>
<h3 id="copy-data-to-new-volume">Copy data to new Volume</h3>
<pre><code>rsync -axv / /mnt/new-vol/
</code></pre>
<p>This will take a while, so get on with some other work</p>
<hr>
<h3 id="once-the-copy-has-finished">Once the copy has finished:</h3>
<ul>
<li>
<p>Instal <code>grub</code> on the new volume</p>
</li>
<li>
<p><code>grub-install --root-directory=/mnt/new-volume --force /dev/xvdf</code></p>
</li>
<li>
<p>(centos 7+) <code>grub2-install --root-directory=/mnt/new-volume --force /dev/xvdf</code></p>
</li>
<li>
<p>Unmount the directory</p>
</li>
<li>
<p><code>sudo umount /mnt/new-vol</code></p>
</li>
<li>
<p>Check the UUID using <code>blkid</code> (make note of this, we need it below)</p>
</li>
<li>
<p><code>tune2fs -U &lt;uuid from ^&gt; /dev/xvdf</code></p>
</li>
<li>
<p>Check the volume lable from the old volume using <code>sudo e2label /dev/xvda1</code> : Should return something like <code>cloudimg-rootfs</code></p>
</li>
<li>
<p>Replace the volume label with the old value with <code>e2label /dev/xvdf cloudimg-rootfs</code></p>
</li>
</ul>
<h3 id="shutdown-the-instance">Shutdown the instance</h3>
<pre><code>sudo shutdown
</code></pre>
<p>Detach the old volume and the new volume from the AWS EC2 console</p>
<p>Attach the new volume (Best to do it by UUID of the EC2 Instance) to <code>/dev/sda1</code></p>
<p>Start the EC2 instance and SSH</p>
<hr>
<h2 id="closing-notes">Closing notes</h2>
<p>Your milage may vary, we are assuming that you have adequate linux experience</p>
<p>I take no responsibility to any damage caused to your instances during this process, you knew the risks by doing this in prod, you take the fall for it. Learn from it and **don&rsquo;t do it in prod again **</p>

                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed"><article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="http://localhost:1313/post/dependabot-for-terraform-and-terraform-modules/">
    
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Dependabot for terraform and terraform modules</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p><p>I recently stumbled across <a href="https://github.blog/2020-06-01-keep-all-your-packages-up-to-date-with-dependabot/">Dependabot</a> and was curious if it can be used to keep Terraform up to date. Turns out you can, but there are some small catches that you should be aware of.</p>
<p>In todays installment, we look at what it is, why you&rsquo;d use it, and how to set it up.</p>
<h2 id="what-is-dependabot">What is Dependabot</h2>
<p>Dependabot is a tool from GitHub that allows automatic updates and patching of code in repositories. This is especially useful as once you get over about 3 terraform dependencies, you start having the issue where Providers become out dated, and modules fall behind on patches to issues.</p></p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"></div>
                            <a href="#" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span></span>
                        <span class="post-card-byline-date"><time datetime="0001-121-01">1 January 0001</time>
                            <span class="bull">&bull;</span> 3 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    

            <article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="http://localhost:1313/post/cloud-init-ovh-and-terraform/">
    
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Cloud-init, OVH and terraform</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p><p>Yup, it&rsquo;s that time of the year again when I talk about some issues I&rsquo;ve had and couldn&rsquo;t find a solution on google so I wrote about it.</p>
<h2 id="what-is-the-problem">What is the problem?</h2>
<p>If you&rsquo;re never used OVH and terraform, you&rsquo;ll know that standing up the instance using terraform is quite easy. But adding a second network adapter and getting that to get DHCP&hellip; No.</p>
<p>I&rsquo;ve previously written about using cloud-init, see below, on local infrastructure.
[</p></p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"></div>
                            <a href="#" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span></span>
                        <span class="post-card-byline-date"><time datetime="0001-121-01">1 January 0001</time>
                            <span class="bull">&bull;</span> 4 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:1313/">Hugo Themes</a> &copy; 0001</section>
                <nav class="site-footer-nav">
                    <a href="http://localhost:1313/">Latest Posts</a>
                    <a href="https://facebook.com" target="_blank" rel="noopener">Facebook</a>
                    <a href="https://twitter.com" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://github.com/jonathanjanssens" target="_blank" rel="noopener">Github</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

<script src="http://localhost:1313/js/sticky-nav-title.min.7c74baa114d72c67b1f5c85f55da35fa76c686efef35103f409f57f6bf3f9057.js" integrity="sha256-fHS6oRTXLGex9chfVdo1&#43;nbGhu/vNRA/QJ9X9r8/kFc="></script>
<script>

    
    
    
    
    $(document).ready(function () {

        var nav = document.querySelector('.site-nav-main .site-nav');
        var feed = document.querySelector('.post-feed');

        var lastScrollY = window.scrollY;
        var lastWindowHeight = window.innerHeight;
        var lastDocumentHeight = $(document).height();
        var ticking = false;

        function onScroll() {
            lastScrollY = window.scrollY;
            requestTick();
        }

        function onResize() {
            lastWindowHeight = window.innerHeight;
            lastDocumentHeight = $(document).height();
            requestTick();
        }

        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(update);
            }
            ticking = true;
        }

        function update() {
            var trigger = feed.getBoundingClientRect().top + window.scrollY;
            var progressMax = lastDocumentHeight - lastWindowHeight;

            
            if (lastScrollY >= trigger - 20) {
                nav.classList.add('fixed-nav-active');
            } else {
                nav.classList.remove('fixed-nav-active');
            }

            ticking = false;
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        window.addEventListener('resize', onResize, false);

        update();

    });
</script>
</body>
</html>