<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
    <title>Kubernetes secrets using Google Secret Manager · breadNET</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="http://localhost:1313/style.main.min.b98e12e6b4acb157747422458845caf0880e6eda788e2e2ee3ecc617a0e9bfc3.css" />

</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
        <a class="site-nav-logo" href="http://localhost:1313/">breadNET</a>
        

        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem">
                    <a href="/">HOME</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="/my-setup">MY SETUP</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="/story">THE STORY</a>
                </li>
                
            </ul>

            
            <span class="nav-post-title dash">Kubernetes secrets using Google Secret Manager</span>
            
        </div>
    </div>

    <div class="site-nav-right">
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem">
                    <a href="https://www.linkedin.com/in/bradley-stannard/">Linkedin</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="https://documentation.breadnet.co.uk/?mtm_campaign=breadnet&amp;mtm_kwd=navbar">Documentation</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="mailto:webmaster@breadnet.co.uk">Contact</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="https://github.com/userbradley">GitHub</a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>
</div>
</div><script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.Casper && window.Casper.stickyNavTitle) {
                window.Casper.stickyNavTitle({
                    navSelector: '.site-nav-main',
                    titleSelector: '.post-full-title',
                    activeClass: 'nav-post-title-active'
                });
            }
        });
    </script>
</header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post  no-image ">

            <header class="post-full-header">

                

                <h1 class="post-full-title">Kubernetes secrets using Google Secret Manager</h1>

                
                    <p class="post-full-custom-excerpt">How to get Google Secret manager secrets in to GKE? Look no further. We discuss options and implementing External Secrets Operator</p>
                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        

                        <section class="post-full-byline-meta">
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2023-1010-10">15 October 2023</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 6 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            

            <section class="post-full-content">
                <div class="post-content">
                    <p>Since my career at the current company cool enough to employ me, I&rsquo;ve been almost exclusively working on GKE (Google&rsquo;s Kubernetes offering)</p>
<p>One (of the many) issues I&rsquo;ve been trying to solve in GKE is how to use Google Secrets (<a href="https://cloud.google.com/secret-manager">Their secret manager</a>) **inside **GKE in a simple mean that doest require crazy add ons, and complexity.</p>
<p>I&rsquo;ve opened a Feature Request, but until then this blog post will explain what options you have, and what I did, and then a walkthrough of how to set up what I&rsquo;ve done</p>
<ul>
<li><a href="https://issuetracker.google.com/issues/305477780">[FR] Native support for Google Secret manager in GKE</a></li>
</ul>
<h2 id="what-is-the-issue-to-start-with">What is the issue to start with</h2>
<p>We have a lot of applications that run on GKE, these span from simple things like a cron job to backup our state projects, all the way to our in house <a href="https://internaldeveloperplatform.org/what-is-an-internal-developer-platform/">multi-layer multi-language IDP</a> - One of the massive issues here is most of these applications need secrets to communicate <em>onwards</em>, be it to Microsoft Auth or to third party APIs.</p>
<p>How we get these secrets in, is a real pain. We used to manage these by using <a href="https://skaffold.dev">Skaffold</a> to pick up local environment variables  at deploy. One issue this has, if the dev doesn&rsquo;t run the pre-requisite <a href="https://taskfile.dev">Task command</a> then the secret gets nulled and things break. This happens maybe twice a week.</p>
<h2 id="what-is-the-proposed-solution">What is the proposed Solution</h2>
<p>Ideally we would allow the application developers to just specify the secret in Google secret manager, and either the file on the pod to mount it to, or the environment variables it should be.</p>
<p>Below details what I want from a solution</p>
<ul>
<li>Ability to use Service account of Pod or specific account using <a href="https://documentation.breadnet.co.uk/kubernetes/gke/configure-gke-workload-identity/">Workload Identity</a></li>
<li>Generate a Kubernetes native secret</li>
<li>Able to mount to pods as either env variables or File</li>
</ul>
<p>I had a dig around on the internet and found a Medium Post which offered the below solutions.
NameCommentsDirectly Fetching SecretsSomething we used to do, but the idea of this post is to prevent thisKubernetes Secrets CSI DriveerWe tried this and goodness me it was <strong>painfull</strong>Using an Init containerNope. This sounds way too complicated and I dont want to have to play about with filesExternal Secrets OperatorSpoiler alertB3rg1a$Looked too complicated for what we were doing
As you can probably guess, we&rsquo;re going to be talking about using External Secrets Operator to get secrets in to our cluster.</p>
<p>Back in August I had trialed using the CSI driver and it was painful. In order to get secrets to become Kubernetes secrets, <a href="https://secrets-store-csi-driver.sigs.k8s.io/topics/sync-as-kubernetes-secret">you had to start a pod and mount the secret to it</a>. This is a security issue.</p>
<h2 id="external-secrets-operator">External Secrets Operator</h2>
<p>I decided to settle on External Secrets Operator (ESO) as it allowed us to sync secrets from GSM on a schedule we define, allows us to specify a service account that has access, and it allows name spacing resources so we can apply RBAC on them.</p>
<p>Let&rsquo;s just set out the scene of our environment, as some parts are very important to pay attention to.
NameOur ValueCluster Name<code>breadnet-cluster</code>Region<code>europe-west2</code>Zone<code>europe-west2-c</code>
Something we really need to make sure we pay attention is the Cluster name and Zone. This is because when using Workload Identity the ESO app makes <a href="https://github.com/external-secrets/external-secrets/blob/7b8f36b2f007306a106863b12c433edd9c8820ea/pkg/provider/gcp/secretmanager/workload_identity.go#L120-L123">API calls to the tokens API, these have to match up exactly</a></p>
<p>First we need to install the External Secrets Operator, You can do this with Helm, but we use Skaffold for all management operations so below is the skaffold file</p>
<pre><code>apiVersion: skaffold/v4beta6
kind: Config
metadata:
  name: external-secrets
deploy:
  helm:
    releases:
      - name: external-secrets
        namespace: external-secrets
        remoteChart: external-secrets
        repo: &quot;https://charts.external-secrets.io&quot;
        upgradeOnChange: true
</code></pre>
<p>Once External Secrets is installed, check all is well. Ideally these should all say <code>1/1</code> under the ready column</p>
<pre><code>➜ kubectl get pods -n external-secrets                         
NAME                                                READY   STATUS    RESTARTS   AGE
external-secrets-7f8fd8d64d-wfkj8                   1/1     Running   0          6d5h
external-secrets-cert-controller-8499548dd6-ttxtf   1/1     Running   0          6d5h
external-secrets-webhook-dbc576595-lkxxm            1/1     Running   0          6d5h
</code></pre>
<p>The next step is to create a Google Cloud Service account in the Service project for your application.</p>
<p>Once done, grant the service account *<code>roles/iam.serviceAccountTokenCreator</code>*on the project.</p>
<p>Next thing is to navigate to Secret manager, locate the secret you want the ESO to have access to, then give that service account Secret Viewer on that Secret.</p>
<p>Custom resource definitions and their <em>imported</em> resources can either be <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#create-a-customresourcedefinition">Cluster Scoped or Namespaced</a>. For our specific configuration, we will be creating a <code>SecretStore</code> opposed to a <code>ClusterSecretStore</code> which is the cluster wide one.</p>
<p>We wont be using <code>ClusterSecretStore</code> as this means a single service account is used cluster wide, which means this service account has way more permissions than is required <a href="https://cloud.google.com/iam/docs/best-practices-service-accounts">(Not good)</a></p>
<p>Before you can move ahead with creating the <code>SecretStore</code> we need to create a kubernetes service account and annotate the account with the GCP Service account. For this, follow my guide from <code>Service account</code> to <code>Kubernetes service account</code> section
[</p>
<p>Configure GKE workload Identity - breadNET Documentation</p>
<p>breadNET Documentation</p>
<p><img src="https://documentation.breadnet.co.uk/favicon.ico" alt="">logo</p>
<p><img src="https://documentation.breadnet.co.uk/assets/images/social/kubernetes/gke/configure-gke-workload-identity.png" alt="">
](<a href="https://documentation.breadnet.co.uk/kubernetes/gke/configure-gke-workload-identity/#service-account">https://documentation.breadnet.co.uk/kubernetes/gke/configure-gke-workload-identity/#service-account</a>)
We will annotate the service account is like below:</p>
<pre><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-accessor
  namespace: secret-store-namespace
  annotations:
    iam.gke.io/gcp-service-account: secret-accessor@secret-accessor-demo.gserviceaccount.com
</code></pre>
<p>Now create the <code>SecretStore</code></p>
<p>If your secrets are in the same project as the GKE cluster, you can omit the <code>clusterProjectId</code> field (I think, I cant remember and their documentation is sparse) How ever if you have secrets in a centralized Secret Project, then you should include this field. I have included it below.</p>
<pre><code>apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcp-store
  namespace: secret-store-namespace
spec:
  provider:
    gcpsm:
      auth:
        workloadIdentity:
          clusterLocation: europe-west2-c
          clusterName: breadnet-cluster
          clusterProjectID: breadnet-gke
          serviceAccountRef:
            name: secret-accessor
      projectID: breadnet-secrets
</code></pre>
<p>Once this is applied, and the service account in the namespace is annotated, you can then access secrets using this store.</p>
<pre><code>apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-credentials
spec:
  refreshInterval: 1h             # rate SecretManager pulls GCPSM
  secretStoreRef:
    kind: SecretStore
    name: gcp-store               # name of the SecretStore (or kind specified)
  target:
    name: database-credentials    # name of the k8s Secret to be created
    creationPolicy: Owner
  data:
  - secretKey: database_username
    remoteRef:
      key: database_username      # name of the GCPSM secret key
  - secretKey: database_password
    remoteRef:
      key: database_password      # name of the GCPSM secret key
</code></pre>
<p>This then allows us to sync the Google cloud secret <code>database_username</code> to the field <code>database_username</code> in the secret called <code>database-credentials</code> in the current namespace.</p>
<p>You&rsquo;re then free to use this secret as you would as a kubernetes native secret.</p>
<p>The below is the link to the Google Secret managet for ESO, go forth and conquer
[</p>
<p>Google Cloud Secret Manager - External Secrets Operator</p>
<p><img src="https://external-secrets.io/latest/assets/images/favicon.png" alt="">External Secrets Operator</p>
<h2 id="heading">](<a href="https://external-secrets.io/latest/provider/google-secrets-manager/">https://external-secrets.io/latest/provider/google-secrets-manager/</a>)</h2>
<p>If you enjoyed this blog post, please consider bookmarking this site!</p>
<p>You may also be interested in my documentation site which will have more in depth examples etc: <a href="documentation.breadnet.co.uk/">documentation.breadnet.co.uk</a></p>
<p>As always you can contact me to discuss this post, or if you need help implementing this as your company please reachout to me and we can discuss ways to get you working cloud native!</p>
<p>Thanks &lt;3</p>

                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed"><article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="http://localhost:1313/post/terraform-state-chicken-and-egg-problem/">
    
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Terraform state chicken and egg problem</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>Terraform is full of chicken and egg problems, let&rsquo;s solve the state one</p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"></div>
                            <a href="#" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span></span>
                        <span class="post-card-byline-date"><time datetime="2023-310-10">4 October 2023</time>
                            <span class="bull">&bull;</span> 3 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    

            <article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="http://localhost:1313/post/kubernetes-at-home/">
    
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Kubernetes at home</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>Ever wondered what it&rsquo;s like running kubernetes at home? This post tries to answer that</p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"></div>
                            <a href="#" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span></span>
                        <span class="post-card-byline-date"><time datetime="2023-511-11">21 November 2023</time>
                            <span class="bull">&bull;</span> 10 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:1313/">breadNET</a> &copy; 2023</section>
                <nav class="site-footer-nav">
                    <a href="http://localhost:1313/">Latest Posts</a>
                    
                    
                    
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

<script src="http://localhost:1313/js/sticky-nav-title.min.7c74baa114d72c67b1f5c85f55da35fa76c686efef35103f409f57f6bf3f9057.js" integrity="sha256-fHS6oRTXLGex9chfVdo1&#43;nbGhu/vNRA/QJ9X9r8/kFc="></script>
<script>

    
    
    
    
    $(document).ready(function () {

        var nav = document.querySelector('.site-nav-main .site-nav');
        var feed = document.querySelector('.post-feed');

        var lastScrollY = window.scrollY;
        var lastWindowHeight = window.innerHeight;
        var lastDocumentHeight = $(document).height();
        var ticking = false;

        function onScroll() {
            lastScrollY = window.scrollY;
            requestTick();
        }

        function onResize() {
            lastWindowHeight = window.innerHeight;
            lastDocumentHeight = $(document).height();
            requestTick();
        }

        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(update);
            }
            ticking = true;
        }

        function update() {
            var trigger = feed.getBoundingClientRect().top + window.scrollY;
            var progressMax = lastDocumentHeight - lastWindowHeight;

            
            if (lastScrollY >= trigger - 20) {
                nav.classList.add('fixed-nav-active');
            } else {
                nav.classList.remove('fixed-nav-active');
            }

            ticking = false;
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        window.addEventListener('resize', onResize, false);

        update();

    });
</script>
</body>
</html>