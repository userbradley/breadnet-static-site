<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
    <title>Nginx and Lets encrypt, a story of reverse proxying Â· Hugo Themes</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="http://localhost:1313/style.main.min.b98e12e6b4acb157747422458845caf0880e6eda788e2e2ee3ecc617a0e9bfc3.css" />

</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
        <a class="site-nav-logo" href="http://localhost:1313/">Hugo Themes</a>
        

        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem">
                    <a href="/">HOME</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="/my-setup">MY SETUP</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="/story">THE STORY</a>
                </li>
                
            </ul>

            
            <span class="nav-post-title dash">Nginx and Lets encrypt, a story of reverse proxying</span>
            
        </div>
    </div>

    <div class="site-nav-right">
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem">
                    <a href="https://www.linkedin.com/in/bradley-stannard/">Linkedin</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="https://documentation.breadnet.co.uk/?mtm_campaign=breadnet&amp;mtm_kwd=navbar">Documentation</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="mailto:webmaster@breadnet.co.uk">Contact</a>
                </li>
                
                <li class="nav-home" role="menuitem">
                    <a href="https://github.com/userbradley">GitHub</a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>
</div>
</div><script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.Casper && window.Casper.stickyNavTitle) {
                window.Casper.stickyNavTitle({
                    navSelector: '.site-nav-main',
                    titleSelector: '.post-full-title',
                    activeClass: 'nav-post-title-active'
                });
            }
        });
    </script>
</header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post  no-image ">

            <header class="post-full-header">

                

                <h1 class="post-full-title">Nginx and Lets encrypt, a story of reverse proxying</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        

                        <section class="post-full-byline-meta">
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="0001-121-01">1 January 0001</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 8 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            

            <section class="post-full-content">
                <div class="post-content">
                    <p>This is something that took some time to get my head around, but once I managed to (somewhat) figure it out, it&rsquo;s made exposing my services to the internet a lot easier</p>
<p>After a few years of building up the courage and knowledge to host stuff that my friends and I can use, it&rsquo;s become apparent that updating a DNS record every time your public IP at home changes, isn&rsquo;t a great way to host things. This is where Nginx reverse proxy comes in.</p>
<blockquote>
<p>I was alerted by a user on reddit that cloudflare have an API you can use if your DNS is managed from them that makes updating dynamic ip&rsquo;s to domains simle if you decide to host a reverse proxy server at home</p></blockquote>
<p>Firstly we will need a server somewhere on the internet. I suggest someone like <a href="https://m.do.co/c/77be3c3aa96c">Digital Ocean</a> or Vultr with their cheapest option. Nginx does not require a large amount of resources to run which is nice.</p>
<p>For this scenario, lets image I am hosting this website on my servers at home, and don&rsquo;t want the whole world to know my home connections IP address. Slap it behind a reverse proxy and problem solved.</p>
<p>In this example I will be using Ubuntu. Any version works, as long as it&rsquo;s not <a href="https://wiki.ubuntu.com/Releases">EOL</a></p>
<p>We can start by installing Nginx</p>
<pre><code>sudo apt-get install nginx -y
</code></pre>
<p>Now once installed, I like to enable it so it starts on a system reboot.</p>
<pre><code>sudo systemctl enable nginx
</code></pre>
<p>Sweet, now if you go to the IP address of your server you should be welcomed with a generic welcome/ hello world. (It&rsquo;s been a while. I cant remember)</p>
<p>If there are issues with Nginx starting, there may be another application running on port 80 or 443. You can check with the below</p>
<pre><code>netstat -plnt | grep 80
netstat -plnt | grep 443
</code></pre>
<h2 id="the-reversey-part">The reverse&rsquo;y part</h2>
<p>Now that we have nginx up and running on our droplet/ vps/ what ever we can start reversing stuff.</p>
<p>Based on where your server is running/ what you intend to use it for, your mileage may vary. I am going to explain 3 types of scenarios I use and why.</p>
<p>The first is a very generic way that you can build on, and the following 3 are how it can be fine tuned</p>
<p>This is the most basic configuration I could think of. You have a server on your network, we will call it <code>edge</code> and on that network you also have a server called <code>app</code> but you don&rsquo;t want to expose the <code>app</code> server to the tinternet.</p>
<p>You will want to make a new nginx config based off what you want the end URL to look like. For simplicity we will make the domain <code>app.breadnet.co.uk</code> but you will need to make this your domain.</p>
<pre><code>sudo nano /etc/nginx/sites-available/app.domain.tld
</code></pre>
<p>In there, paste the following:</p>
<pre><code>server {     
      listen 80;   
      listen [::]:80;     
      server_name &lt;domain&gt;.breadnet.co.uk;
     add_header Strict-Transport-Security &quot;max-age=15552000; includeSubDomains&quot; always;      
	access_log /var/log/nginx/&lt;domain&gt;/access.log;
	error_log /var/log/nginx/&lt;domain&gt;/error.log;
       location / {         
       proxy_pass &lt;ip/hostname&gt;;         
       proxy_next_upstream error  timeout invalid_header http_500 http_502 http_503;         
       proxy_set_header Host $host;        
       proxy_set_header X-Real-IP $remote_addr;    
       proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto https;
       proxy_redirect off;         
       proxy_read_timeout 5m;     
   }  
client_max_body_size 10M; 
}
</code></pre>
<p>You will need to edit servername to your domain, and then under <code>proxy_pass</code> you need to ensure this points to the domain or IP address of <code>app</code></p>
<p>I find with some services like Cachet and sensative, the web server config on the serving node needs to have it&rsquo;s web address set as the end result of passing it via nginx.</p>
<p>Now we can enable the page:</p>
<pre><code>sudo ln -s /etc/nginx/sites-available/app.breadnet.co.uk /etc/nginx/sites-enabled/app.breadnet.co.uk
</code></pre>
<p>Once done, restart nginx with <code>sudo systemctl restart nginx</code></p>
<p>You will need to login to you DNS providor and add an A record pointing to the IP address of <code>edge</code> be it on your home network (in that case you will need to open a port) or a public server on digital ocean or vultr.</p>
<p>Enable SSL with Certbot. You should have this installed by now but if not please install it</p>
<pre><code>sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

certbot --nginx -d app.domain.com
</code></pre>
<hr>
<p>Below are more case specific examples you can build off of</p>
<h2 id="1-opening-a-port">1: Opening a port</h2>
<p>I run a media server called jellyfin on my local servers at home, and would like to be able to access it out and about with out having to connect to a VPN, as well as allow my friends and family to use it. Due to it&rsquo;s nature I have opened the firewall at my home to only allow port 8069 from my Digital ocean droplet to connect.</p>
<p>To enable this to work, you will need 3 things.</p>
<ol>
<li>Ability to copy, paste and edit</li>
<li>IP address of your home internet connection</li>
<li>Domain name like <code>media.example.com</code> or any subdomain you like</li>
</ol>
<p>Firstly open the firewall at home to forward connections on the port of needing to the server. Once that is done, I personally add an entry in to <code>/etc/hosts</code> so as my IP address changes, I don&rsquo;t need to update multiple nginx config files.</p>
<pre><code>sudo nano /etc/hosts
</code></pre>
<p>In this file you will want to give the IP a name, I use <code>home.connection</code> so my file looks like:</p>
<pre><code>root@reversinator:~$ cat /etc/hosts
127.0.0.1	localhost
127.0.1.1	reversinator
151.101.192.144 home.connection


# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre>
<p>Obviously change out your IP address and name.</p>
<p>Now we need to edit the nginx config. For this I personally prefer to name the file the page it will point to. Just makes auditing quicker</p>
<pre><code>/etc/nginx/sites-available/&lt;page.domain.tld&gt;
</code></pre>
<p>So here it would be <code>media.example.com</code> but you&rsquo;re welcome to name your config file <code>jeff</code></p>
<p>In that file, paste and edit</p>
<pre><code>server {     
      listen 80;   
      listen [::]:80;     
      server_name &lt;sub&gt;.&lt;domain&gt;.&lt;tld&gt;;
     add_header Strict-Transport-Security &quot;max-age=15552000; includeSubDomains&quot; always;      
	access_log /var/log/nginx/&lt;domain&gt;/access.log;
	error_log /var/log/nginx/&lt;domain&gt;/error.log;
       location / {         
       proxy_pass &lt;ip/hostname&gt;;         
       proxy_next_upstream error  timeout invalid_header http_500 http_502 http_503;         
       proxy_set_header Host $host;        
       proxy_set_header X-Real-IP $remote_addr;    
       proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto https;
       proxy_redirect off;         
       proxy_read_timeout 5m;     
   }  
client_max_body_size 10M; 
}
</code></pre>
<p>Here you will need to change <code>&lt;sub&gt;.&lt;domain&gt;.&lt;tld&gt;</code> to the domain that this will refer to. You can also add <code>www.</code><!-- raw HTML omitted -->.<!-- raw HTML omitted -->.<!-- raw HTML omitted -->`` after the first one if you want <code>www.</code> to go to that page.</p>
<p>Once that&rsquo;s done, you will also need to change <code>&lt;ip/hostname&gt;</code> to reflect where the content is hosted, or what you are reverse proxying. Once that is done, you may also want to edit the line which reads <code>access_log</code> to match <code>&lt;domain&gt;</code> to the domain it is on. This just helps to separate logs for easy viewing.</p>
<p>Once done, you will need to symlink the config file to <code>sites-enabled</code> and then restart Nginx.</p>
<h2 id="2-using-zerotier"><strong>2: Using Zerotier</strong></h2>
<p>I&rsquo;m not sure how best to describe Zerotier other than as a Virtual lan that spans the internet. You connect to it though an application either on windows or linux.</p>
<p>You will need to create an account and install it on both machines.</p>
<p>Create an account at <a href="https://my.zerotier.com/">my.zerotier.com/</a></p>
<p>Once your account is creates, click <code>Networks</code> at the top and then <code>+ Create a Network</code></p>
<p>You will see one appear under the <code>Your Networks</code> section Â 
<img src="__GHOST_URL__/content/images/2020/06/image-14.png" alt="">
Click the ID of the network and pick the network range you want. You NEED it to not be used anywhere else!
<img src="__GHOST_URL__/content/images/2020/06/image-15.png" alt="">
Once that is done, you will need to install Zerotier on your content hosting server, as well as the reverse proxy server.</p>
<p>If you trust SSL on linux:</p>
<pre><code>curl -s https://install.zerotier.com | sudo bash
</code></pre>
<p>Else, it can be installed <a href="https://www.zerotier.com/download/">here</a></p>
<p>Now we need to add the server&rsquo;s to the network!</p>
<pre><code>sudo zerotier-cli join &lt;network ID&gt;
</code></pre>
<p>If it returns with <code>200</code> it&rsquo;s happy days. Wait a few minutes and you should see the first server show up in the management page. Add a name to it so you know what&rsquo;s what.</p>
<p>Repeat for the other server.</p>
<p>make sure you can ping the servers via zerotier. If you cant, wait a few minutes and run pings from both servers to each other. It&rsquo;s weird but works eventually.</p>
<p>Next we will need to configure NGINX. This is exactly the same as all the other configurations except we will use the zerotier IP address of the content server opposed to another address.</p>
<p>As usual, make this file in the Â <code>/etc/nginx/sites-available/</code> folder with the name being the end domain. (see other configs above)</p>
<pre><code>server {     
      listen 80;   
      listen [::]:80;     
      server_name &lt;sub&gt;.&lt;domain&gt;.&lt;tld&gt;;
     add_header Strict-Transport-Security &quot;max-age=15552000; includeSubDomains&quot; always;      
	access_log /var/log/nginx/&lt;domain&gt;/access.log;
	error_log /var/log/nginx/&lt;domain&gt;/error.log;
       location / {         
       proxy_pass &lt;zerotier address of content server&gt;;         
       proxy_next_upstream error  timeout invalid_header http_500 http_502 http_503;         
       proxy_set_header Host $host;        
       proxy_set_header X-Real-IP $remote_addr;    
       proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto https;
       proxy_redirect off;         
       proxy_read_timeout 5m;     
   }  
client_max_body_size 10M; 
}
</code></pre>
<p>Now symlink it</p>
<pre><code>sudo ln -s /etc/nginx/sites-available/config_name /etc/nginx/sites-enabled/config_name
</code></pre>
<p>Restart nginx and you should be off to the races</p>
<pre><code>systemctl restart nginx
</code></pre>
<p>As with all of these, I suggest SSL!</p>
<p>This is at the top of the page and I suggest you do this!</p>
<p>As will anything on this site, if you have issues or nothing makes sense, drop me an email!</p>
<hr>
<p>You can hire me via <a href="https://www.upwork.com/freelancers/~01c61ee9802b94133e">Upwork</a> or <a href="mailto:work@breadnet.co.uk">emailing me</a> for weekend projects!</p>

                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed"><article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="http://localhost:1313/post/wasabi-x-terraform/">
    
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Resolving the &#39;sts:GetCallerIdentity&#39; error</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p><p>I&rsquo;ll be honest, other than the 90 day delete policy (which annoys me to no end) wasabi is <strong>dank****af</strong>.</p>
<p>Didn&rsquo;t expect me to start a blog post with that, did you? (Looking at you wasabi employees ð)</p>
<h2 id="the-problem-at-hand">The problem at hand</h2>
<p>I&rsquo;m in the middle of a digital transformation, which means re-defining how I do things.</p>
<p>One of those is how I deal with terraform state.</p>
<p>Those of you who don&rsquo;t *terraform on the regular, *let me explain the issue.</p></p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"></div>
                            <a href="#" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span></span>
                        <span class="post-card-byline-date"><time datetime="0001-121-01">1 January 0001</time>
                            <span class="bull">&bull;</span> 3 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    

            <article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="http://localhost:1313/post/moving-to-the-cloud-1/">
    
                <header class="post-card-header">
                    

                    <h2 class="post-card-title">Moving to the cloud: Intro</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p><p>We will start this story with the facts. I am getting older, and I want to move out. As I get older, I am forced to accept more responsibilities, like paying for my own electricity.</p>
<p>As any selfhoster will tell you, this is what bleeds their wallets dry.</p>
<p>Moving to the cloud is not a decision I took lightly, there was alot of consideration put in to this. I was considering purchasing a newer server, probably a Dell r610 or something of that range and maxxing out the specs, but that pulls a fair bit of electricity, and where I plan to live, would also be in the same room as where I sleep. Fun</p></p>
                </section>
    
            </a>

            <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"></div>
                            <a href="#" class="static-avatar author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span></span>
                        <span class="post-card-byline-date"><time datetime="0001-121-01">1 January 0001</time>
                            <span class="bull">&bull;</span> 8 min read</span>
                    </div>
                </footer>
    
        </div>

</article>
    
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="http://localhost:1313/">Hugo Themes</a> &copy; 0001</section>
                <nav class="site-footer-nav">
                    <a href="http://localhost:1313/">Latest Posts</a>
                    <a href="https://facebook.com" target="_blank" rel="noopener">Facebook</a>
                    <a href="https://twitter.com" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://github.com/jonathanjanssens" target="_blank" rel="noopener">Github</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

<script src="http://localhost:1313/js/sticky-nav-title.min.7c74baa114d72c67b1f5c85f55da35fa76c686efef35103f409f57f6bf3f9057.js" integrity="sha256-fHS6oRTXLGex9chfVdo1&#43;nbGhu/vNRA/QJ9X9r8/kFc="></script>
<script>

    
    
    
    
    $(document).ready(function () {

        var nav = document.querySelector('.site-nav-main .site-nav');
        var feed = document.querySelector('.post-feed');

        var lastScrollY = window.scrollY;
        var lastWindowHeight = window.innerHeight;
        var lastDocumentHeight = $(document).height();
        var ticking = false;

        function onScroll() {
            lastScrollY = window.scrollY;
            requestTick();
        }

        function onResize() {
            lastWindowHeight = window.innerHeight;
            lastDocumentHeight = $(document).height();
            requestTick();
        }

        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(update);
            }
            ticking = true;
        }

        function update() {
            var trigger = feed.getBoundingClientRect().top + window.scrollY;
            var progressMax = lastDocumentHeight - lastWindowHeight;

            
            if (lastScrollY >= trigger - 20) {
                nav.classList.add('fixed-nav-active');
            } else {
                nav.classList.remove('fixed-nav-active');
            }

            ticking = false;
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        window.addEventListener('resize', onResize, false);

        update();

    });
</script>
</body>
</html>