{{- /* ========================= */ -}}
{{- /* Hugo Markdown render hook */ -}}
{{- /* ========================= */ -}}

{{- $image_sizes := slice "420" "789" "1019" "1430" -}}
{{- $image_quality := "Lanczos" -}}
{{- $alt := .Text -}}
{{- $label := .Text -}}
{{- $caption := "" -}}
{{- if ne .Title "" -}}
{{- $caption = .Title | $.Page.RenderString -}}
{{- $label = $caption -}}
{{- end -}}

{{- $destination := .Destination -}}
{{- $image := .Page.Resources.GetMatch $destination -}}

{{- /* Only attempt processing if $image is a Hugo Resource */ -}}
{{- if $image }}
{{- $fallback := $image.Resize (print "789x jpg " $image_quality) -}}
<figure role="figure" aria-label="{{ $label | plainify }}">
    <img
            alt="{{ $caption | markdownify | plainify }}"
            title="{{ $label | plainify }}"
            width="{{ $image.Width }}"
            height="{{ $image.Height }}"
            src="{{ $fallback.RelPermalink }}"
            loading="lazy"
            decoding="async"
            srcset="
        {{- range $image_sizes -}}
          {{- if ge $image.Width . -}}
            {{- with $image.Resize (print . "x webp " $image_quality) -}}
    {{- print .RelPermalink " " .Width "w, " -}}
    {{- end -}}
    {{- end -}}
    {{- end -}}"
    sizes="(min-width: 1200px) 33vw, (min-width: 800px) 50vw, 100vw"
    />
    {{- if $caption -}}<figcaption>{{ $caption }}</figcaption>{{- end -}}
</figure>

{{- else if hasPrefix $destination "http" -}}
{{- /* External images — cannot process */ -}}
<figure role="figure" aria-label="{{ $label | plainify }}">
    <img
            alt="{{ $caption | markdownify | plainify }}"
            title="{{ $label | plainify }}"
            src="{{ $destination }}"
            loading="lazy"
            decoding="async"
    />
    {{- if $caption -}}<figcaption>{{ $caption }}</figcaption>{{- end -}}
</figure>

{{- else if hasPrefix $destination "/" -}}
{{- /* Site-root images in /static — cannot process */ -}}
<figure role="figure" aria-label="{{ $label | plainify }}">
    <img
            alt="{{ $caption | markdownify | plainify }}"
            title="{{ $label | plainify }}"
            src="{{ $destination }}"
            loading="lazy"
            decoding="async"
    />
    {{- if $caption -}}<figcaption>{{ $caption }}</figcaption>{{- end -}}
</figure>

{{- else -}}
{{- /* Fallback if nothing matches */ -}}
<figure role="figure" aria-label="{{ $label | plainify }}">
    <img
            alt="{{ $caption | markdownify | plainify }}"
            title="{{ $label | plainify }}"
            src="{{ $destination }}"
            loading="lazy"
            decoding="async"
    />
    {{- if $caption -}}<figcaption>{{ $caption }}</figcaption>{{- end -}}
</figure>
{{- end -}}
